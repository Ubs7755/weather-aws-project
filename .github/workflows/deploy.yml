- name: Deploy to EC2
      env:
        PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        HOST: ${{ secrets.EC2_HOST }}
        ECR_URL: ${{ secrets.ECR_REPOSITORY_URL }}
        WEATHER_KEY: ${{ secrets.WEATHER_API_KEY }}
      run: |
        echo "$PRIVATE_KEY" > private_key.pem
        chmod 600 private_key.pem
        ssh -o StrictHostKeyChecking=no -i private_key.pem ubuntu@$HOST "
          aws ecr get-login-password --region ap-south-1 | sudo docker login --username AWS --password-stdin $ECR_URL
          sudo docker pull $ECR_URL:latest
          sudo docker stop weather-app || true
          sudo docker rm weather-app || true
          sudo docker run -d \
            -p 5000:5000 \
            -e WEATHER_API_KEY=$WEATHER_KEY \
            --name weather-app \
            --restart always \
            $ECR_URL:latest
        "
        rm -f private_key.pem